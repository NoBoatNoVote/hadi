<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হাদিসমগ্র</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
		@font-face {
			font-family: 'Kalpurush';
			src: url('https://github.com/mahtab-alam/Kalpurush-Font/raw/main/kalpurush.ttf') format('truetype');
			font-display: swap;
		}
        /* মেসনরি লেআউট */
        .collage-grid {
            column-gap: 12px;
            column-count: 2;
        }
        @media (min-width: 1024px) {
            .collage-grid {
                column-count: 5;
            }
        }
        .collage-item {
            break-inside: avoid;
            margin-bottom: 12px;
            animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .collage-item img {
            width: 100%;
            display: block;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
        }
        .collage-item img:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(220, 38, 38, 0.2);
        }

        /* মোডাল ও ভিউয়ার অ্যানিমেশন */
        #viewer-overlay, #upload-modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #viewer-overlay.active, #upload-modal.active {
            opacity: 1;
            visibility: visible;
        }

        #progress-container {
            display: none;
        }
    </style>
</head>
<body class="bg-zinc-50 flex flex-col min-h-screen">

    <!-- হেডার -->
    <header class="bg-red-600 text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-black uppercase tracking-tighter italic">হাদিসমগ্র</h1>
            <button onclick="toggleUploadModal(true)" class="bg-white text-red-600 px-5 py-2 rounded-full font-bold text-sm shadow-lg hover:bg-red-50 active:scale-95 transition-all">
                + আপলোড করুন
            </button>
        </div>
    </header>

    <!-- গ্যালারি -->
    <main class="flex-grow p-4 lg:p-8">
        <div id="gallery" class="collage-grid"></div>
        <!-- লোডিং ইন্ডিকেটর -->
        <div id="sentinel" class="h-40 flex justify-center items-center">
            <div id="loader-content" class="flex flex-col items-center gap-3">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-red-100 border-t-red-600"></div>
                <p class="text-red-600 text-[10px] font-bold uppercase tracking-widest italic">ছবি খোঁজা হচ্ছে...</p>
            </div>
        </div>
    </main>

    <!-- ফুটার -->
    <footer class="bg-red-600 text-white py-8 border-t-8 border-red-700 mt-auto">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm font-bold tracking-widest opacity-90 uppercase">&copy; শা/উ/য়া হাদী ফ্যান</p>
        </div>
    </footer>

    <!-- আপলোড মোডাল (কাস্টম ফর্ম) -->
    <div id="upload-modal" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 overflow-y-auto" onclick="toggleUploadModal(false)">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl relative transform transition-transform duration-300" onclick="event.stopPropagation()">
            <button onclick="toggleUploadModal(false)" class="absolute top-5 right-5 text-gray-400 hover:text-red-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-3xl font-black text-red-600 mb-2 italic">ছবি পাঠান</h2>
            <p class="text-gray-500 text-sm mb-8">স্ক্রিনশট পাঠানোর জন্য নিচের ফর্মটি পূরণ করুন।</p>
            
            <form id="custom-email-form" class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest">নাম</label>
                    <input type="text" id="sender-name" name="name" placeholder="নাম লিখুন" required class="w-full bg-gray-50 border-2 border-gray-100 p-4 rounded-xl focus:border-red-500 outline-none transition-all placeholder:text-gray-300">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest">ছবি সিলেক্ট করুন</label>
                    <div class="relative group">
                        <input type="file" id="file-input" accept="image/*" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                        <div class="w-full border-2 border-dashed border-gray-200 p-6 rounded-xl text-center group-hover:border-red-400 transition-colors">
                            <span class="text-gray-400 text-sm" id="file-label">ছবিটি এখানে ড্র্যাগ করুন</span>
                        </div>
                    </div>
                </div>

                <!-- কাস্টম প্রগ্রেস বার -->
                <div id="progress-container" class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span id="progress-status-text" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest italic">প্রসেসিং...</span>
                        <span id="progress-percent" class="text-[10px] font-bold text-red-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-red-600 h-full w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-red-600 text-white font-black py-4 rounded-xl shadow-lg shadow-red-200 hover:bg-red-700 active:scale-95 transition-all uppercase tracking-widest">
                    ছবি পাঠিয়ে দিন
                </button>
                <p id="status-msg" class="text-center text-xs font-bold uppercase mt-4"></p>
            </form>
        </div>
    </div>

    <!-- ইমেজ ভিউয়ার -->
    <div id="viewer-overlay" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 cursor-zoom-out" onclick="closeViewer()">
        <img id="viewer-img" src="" alt="View" class="max-w-full max-h-full rounded shadow-2xl">
    </div>

    <script>
        // --- কনফিগারেশন ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-cxX7iTBiclO_fxFlw5ALbiOKG5HUActQYQQ8JNOEUJZx41FeVYKI2_8DG5aOEd9-/exec";
        const ASSETS_PATH = 'assets/'; 
        const IMAGE_EXTENSION = '.jpg'; 

        const uploadModal = document.getElementById('upload-modal');
        const customForm = document.getElementById('custom-email-form');
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.getElementById('file-label');
        const statusMsg = document.getElementById('status-msg');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressStatusText = document.getElementById('progress-status-text');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileLabel.innerText = fileInput.files[0].name;
                fileLabel.classList.add('text-red-600');
            }
        });

        function toggleUploadModal(show) {
            uploadModal.classList.toggle('active', show);
            if (!show) resetForm();
        }

        function resetForm() {
            customForm.reset();
            fileLabel.innerText = "ছবিটি এখানে ড্র্যাগ করুন";
            fileLabel.classList.remove('text-red-600');
            progressContainer.style.display = 'none';
            statusMsg.innerText = "";
        }

        customForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const file = fileInput.files[0];

            if (!file) return;

            btn.disabled = true;
            btn.innerText = "অপেক্ষা করুন...";
            progressContainer.style.display = 'block';
            updateProgress(20, "ছবি রিড করা হচ্ছে...");

            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    updateProgress(50, "সার্ভারে কানেক্ট করা হচ্ছে...");
                    
                    const base64Data = reader.result.split(',')[1];
                    const payload = {
                        name: document.getElementById('sender-name').value,
                        message: document.getElementById('sender-msg').value,
                        filename: file.name,
                        mimeType: file.type,
                        data: base64Data
                    };

                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });

                    updateProgress(100, "সম্পন্ন!");
                    statusMsg.className = "text-center text-xs font-bold uppercase text-green-600";
                    statusMsg.innerText = "ছবি মেইলে পাঠানো হয়েছে!";
                    
                    setTimeout(() => toggleUploadModal(false), 2000);
                };
            } catch (err) {
                statusMsg.className = "text-center text-xs font-bold uppercase text-red-600";
                statusMsg.innerText = "ত্রুটি: আবার চেষ্টা করুন";
                btn.disabled = false;
            }
        });

        function updateProgress(val, text) {
            progressBar.style.width = val + "%";
            progressPercent.innerText = val + "%";
            progressStatusText.innerText = text;
        }

        // --- গ্যালারি লজিক ---
        const gallery = document.getElementById('gallery');
        const viewerOverlay = document.getElementById('viewer-overlay');
        const viewerImg = document.getElementById('viewer-img');
        const loaderContent = document.getElementById('loader-content');
        
        let currentIndex = 1;
        const batchSize = 10;
        let isLoading = false;
        let stopLoading = false;
        let consecutiveFails = 0;

        function createImage(index) {
            const container = document.createElement('div');
            container.className = 'collage-item';
            const img = document.createElement('img');
            img.src = `${ASSETS_PATH}${index}${IMAGE_EXTENSION}`;
            img.loading = 'lazy';
            img.onclick = () => openViewer(img.src);
            
            img.onerror = () => {
                container.remove();
                consecutiveFails++;
                // যদি ৩টি ছবি পরপর না পাওয়া যায়, তবে লোডিং বন্ধ করে দেওয়া হবে
                if (consecutiveFails >= 3) {
                    stopLoading = true;
                    loaderContent.classList.add('hidden');
                }
            };

            img.onload = () => {
                consecutiveFails = 0; // ছবি পাওয়া গেলে কাউন্টার রিসেট হবে
            }
            
            container.appendChild(img);
            return container;
        }

        function loadMore() {
            if (isLoading || stopLoading) return;
            isLoading = true;
            for (let i = 0; i < batchSize; i++) {
                if(stopLoading) break;
                gallery.appendChild(createImage(currentIndex));
                currentIndex++;
            }
            setTimeout(() => { isLoading = false; }, 300);
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadMore();
        }, { rootMargin: '800px' });
        observer.observe(document.getElementById('sentinel'));

        function openViewer(src) {
            viewerImg.src = src;
            viewerOverlay.classList.add('active');
        }
        function closeViewer() { viewerOverlay.classList.remove('active'); }
    </script>
</body>
</html>